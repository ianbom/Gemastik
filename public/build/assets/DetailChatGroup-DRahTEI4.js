import{r as n,j as e,S as X,J as de}from"./app-DqvPgPLX.js";import{X as D,A as T,a as L,b as z,M as Z,S as oe,C as xe}from"./CitizenLayout-CZTR47zY.js";import{B as c,I as ue}from"./input-_-d2rHVp.js";import{C as he}from"./card-f358nuNf.js";import{T as pe}from"./textarea-CC7NFrUF.js";import{S as fe}from"./search-BSytNz48.js";import{U as F}from"./users-C4kToFlf.js";import{c as b}from"./createLucideIcon-9_-YZXNr.js";import"./index-28FC01iy.js";import"./Combination-bzKAMG6s.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=b("File",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=b("Image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=b("Paperclip",[["path",{d:"m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48",key:"1u3ebp"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=b("Reply",[["polyline",{points:"9 17 4 12 9 7",key:"hvgpf2"}],["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=b("Video",[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]]),ve=({messages:d,allGroups:o,activeGroupId:l,currentUserId:u})=>{const[h,k]=n.useState(""),[g,R]=n.useState(""),[I,A]=n.useState(!1),[S,j]=n.useState(!1),[x,E]=n.useState(null),[m,P]=n.useState(null),[w,B]=n.useState(null),[p,Y]=n.useState(!1),ee=n.useRef(null),M=n.useRef(null);console.log("Tipe activeGroupId:",typeof l,"| Nilai:",l);const C=Number(l),f=o.find(s=>s.id===C)||o[0];o.find(s=>s.id===C)||console.warn(`Grup dengan ID ${C} tidak ditemukan di dalam 'allGroups'. Kembali ke grup pertama.`),console.log("Grup Aktif yang Ditemukan:",f),n.useEffect(()=>{const s=()=>{const t=window.innerWidth<768;Y(t),t||j(!0)};return s(),window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[]);const U=o.filter(s=>s.mission.title.toLowerCase().includes(h.toLowerCase()));n.useEffect(()=>{},[d]);const se=s=>{var a;const t=(a=s.target.files)==null?void 0:a[0];if(t){if(t.size>10*1024*1024){alert("File terlalu besar. Maksimal 10MB.");return}if(!["image/jpeg","image/png","image/gif","video/mp4","video/webm","video/ogg"].includes(t.type)){alert("Tipe file tidak didukung. Gunakan gambar (JPEG, PNG, GIF) atau video (MP4, WebM, OGG).");return}P(t);const r=URL.createObjectURL(t);B(r)}},W=()=>{P(null),w&&(URL.revokeObjectURL(w),B(null)),M.current&&(M.current.value="")},O=()=>{E(null)},_=s=>{const t=new Date(s),i=(new Date().getTime()-t.getTime())/(1e3*60*60);return i<24?t.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"}):i<168?t.toLocaleDateString("id-ID",{weekday:"short",hour:"2-digit",minute:"2-digit"}):t.toLocaleDateString("id-ID",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"})},te=s=>new Date(s).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"}),$=s=>s.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2),ae=s=>s.chats&&s.chats.length>0?s.chats[0]:null,re=s=>s&&d.find(t=>t.id===s)||null,ie=s=>{const t=s.id;t!==l&&(console.log(`Navigating from group ${l} to ${t}`),X.get(route("chatgroup.show",{id:t}),{},{preserveState:!0,replace:!0})),p&&j(!1)},K=()=>{j(!S)},ne=()=>{p&&S&&j(!1)},V=async s=>{if(s.preventDefault(),!(!g.trim()&&!m||I)){A(!0);try{const t=new FormData;g.trim()&&t.append("content",g.trim()),m&&t.append("media_url",m),x&&t.append("reply_id",x.id.toString()),await X.post(`/chat-groups/${l}/messages`,t,{preserveState:!0,preserveScroll:!0,headers:{"Content-Type":"multipart/form-data"},onSuccess:()=>{R(""),W(),O()}})}catch(t){console.error("Failed to send message:",t)}finally{A(!1)}}},le=(s=>{const t={};return s.forEach(a=>{const i=te(a.created_at);t[i]||(t[i]=[]),t[i].push(a)}),t})(d),me=s=>s.user.id===u,H=s=>{E(s)},ce=s=>s.startsWith("image/")?e.jsx(je,{className:"w-4 h-4"}):s.startsWith("video/")?e.jsx(we,{className:"w-4 h-4"}):e.jsx(ge,{className:"w-4 h-4"});return e.jsxs("div",{className:"relative flex h-screen bg-background",children:[e.jsx("input",{ref:M,type:"file",accept:"image/*,video/*",onChange:se,className:"hidden"}),p&&S&&e.jsx("div",{className:"fixed inset-0 z-40 bg-black/50 backdrop-blur-sm md:hidden",onClick:ne}),e.jsx("div",{className:` ${S?"translate-x-0":"-translate-x-full"} ${p?"fixed left-0 top-0 z-50 h-full":"relative"} w-80 max-w-[85vw] overflow-hidden border-r bg-card transition-transform duration-300 ease-in-out md:static md:max-w-none md:translate-x-0`,children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex-shrink-0 p-4 border-b",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Grup Chat"}),e.jsx(c,{variant:"ghost",size:"sm",className:"md:hidden",onClick:()=>j(!1),children:e.jsx(D,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"relative",children:[e.jsx(fe,{className:"absolute w-4 h-4 transform -translate-y-1/2 left-3 top-1/2 text-muted-foreground"}),e.jsx(ue,{type:"text",placeholder:"Cari grup chat...",value:h,onChange:s=>k(s.target.value),className:"pl-10"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:U.length===0?e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"py-8 text-center",children:[e.jsx(F,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:h?"Tidak ada grup yang ditemukan":"Belum ada grup chat"})]})}):e.jsx("div",{className:"p-2 space-y-1",children:U.map(s=>{const t=ae(s),a=s.id===l;return e.jsx(he,{className:`cursor-pointer p-3 transition-all duration-200 hover:bg-accent active:scale-[0.98] ${a?"border-primary bg-accent ring-1 ring-primary/20":""}`,onClick:()=>ie(s),children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsxs(T,{className:"flex-shrink-0 w-10 h-10 sm:h-12 sm:w-12",children:[e.jsx(L,{src:s.mission.thumbnail||"",alt:s.mission.title}),e.jsx(z,{className:"text-xs bg-sky-600 text-primary-foreground",children:$(s.mission.title)})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between mb-1",children:[e.jsx("h3",{className:"pr-2 text-sm font-medium truncate text-foreground",children:s.mission.title}),s.unread_messages_count&&s.unread_messages_count>0&&e.jsx("span",{className:"inline-flex min-w-[1.25rem] flex-shrink-0 items-center justify-center rounded-full bg-primary px-2 py-1 text-xs font-bold leading-none text-white",children:s.unread_messages_count>99?"99+":s.unread_messages_count})]}),t&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{className:"text-xs truncate text-muted-foreground",children:[e.jsx("span",{className:"font-medium",children:"Last Message:"})," ",t.content||"Media"]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:_(t.created_at)})]}),!t&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Belum ada pesan"})]})]})},s.id)})})})]})}),e.jsx("div",{className:"flex flex-col flex-1 min-w-0",children:f?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center justify-between p-3 border-b bg-card sm:p-4",children:e.jsxs("div",{className:"flex items-center flex-1 min-w-0 space-x-3",children:[e.jsx(c,{variant:"ghost",size:"sm",className:"p-2 md:hidden",onClick:K,children:e.jsx(Z,{className:"w-4 h-4"})}),e.jsxs(T,{className:"w-8 h-8 sm:h-10 sm:w-10",children:[e.jsx(L,{src:f.mission.thumbnail||"",alt:f.mission.title}),e.jsx(z,{className:"text-xs bg-sky-600 text-primary-foreground",children:$(f.mission.title)})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-sm font-semibold truncate text-foreground sm:text-base",children:f.mission.title}),e.jsx("p",{className:"text-xs truncate text-muted-foreground sm:text-sm",children:"Grup Chat Misi"})]})]})}),e.jsxs("div",{className:"flex-1 p-2 space-y-2 overflow-y-auto sm:space-y-4 sm:p-4",children:[Object.entries(le).map(([s,t])=>e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center justify-center my-3 sm:my-4",children:e.jsx("div",{className:"px-2 py-1 rounded-full bg-accent sm:px-3",children:e.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:s})})}),t.map((a,i)=>{var q,J;const r=me(a),v=i>0&&t[i-1].user.id===a.user.id,N=i>0&&new Date(a.created_at).getTime()-new Date(t[i-1].created_at).getTime()<3e5,y=re(a.reply_id);return e.jsx("div",{className:`group flex ${r?"justify-end":"justify-start"} ${v&&N?"mt-0.5 sm:mt-1":"mt-2 sm:mt-4"}`,children:e.jsxs("div",{className:`flex max-w-[85%] items-start sm:max-w-[70%] ${r?"flex-row-reverse":"flex-row"}`,children:[(!v||!N)&&e.jsxs(T,{className:`h-6 w-6 flex-shrink-0 sm:h-8 sm:w-8 ${r?"ml-2 sm:ml-3":"mr-2 sm:mr-3"}`,children:[e.jsx(L,{src:a.user.profile_url||"",alt:a.user.name}),e.jsx(z,{className:"text-xs bg-secondary text-secondary-foreground",children:$(a.user.name)})]}),v&&N&&e.jsx("div",{className:`w-6 flex-shrink-0 sm:w-8 ${r?"ml-2 sm:ml-3":"mr-2 sm:mr-3"}`}),e.jsxs("div",{className:"relative flex-1 min-w-0",children:[(!v||!N)&&e.jsxs("div",{className:`mb-1 flex items-center justify-between ${r?"flex-row-reverse":"flex-row"}`,children:[e.jsxs("div",{className:`flex items-baseline ${r?"flex-row-reverse":""}`,children:[e.jsx("span",{className:"text-xs font-medium text-foreground sm:text-sm",children:r?"Anda":a.user.name}),e.jsx("span",{className:`text-xs text-muted-foreground ${r?"mr-2":"ml-2"}`,children:_(a.created_at)})]}),e.jsx(c,{variant:"ghost",size:"sm",className:"w-5 h-5 p-0 transition-opacity opacity-0 group-hover:opacity-100 sm:h-6 sm:w-6",onClick:()=>H(a),children:e.jsx(G,{className:"w-2 h-2 sm:h-3 sm:w-3"})})]}),e.jsxs("div",{className:`relative rounded-lg p-2 sm:p-3 ${r?"ml-auto bg-sky-500 text-primary-foreground":"border bg-card"}`,children:[y&&e.jsxs("div",{className:`mb-2 rounded border-l-2 p-2 ${r?"border-primary-foreground/30 bg-primary-foreground/10":"border-primary bg-muted"}`,children:[e.jsxs("div",{className:`text-xs font-medium ${r?"text-primary-foreground/70":"text-muted-foreground"}`,children:["Membalas"," ",y.user.id===u?"Anda":y.user.name]}),e.jsx("div",{className:`text-xs ${r?"text-primary-foreground/90":"text-foreground/70"} truncate`,children:y.content||(y.media_url?"Media":"Pesan")})]}),a.content&&e.jsx("p",{className:"text-xs break-words whitespace-pre-wrap sm:text-sm",children:a.content}),a.media_url&&e.jsx("div",{className:`${a.content?"mt-2 sm:mt-3":""}`,children:a.media_type==="video"||(q=a.media_type)!=null&&q.startsWith("video/")?e.jsx("video",{src:`/storage/${a.media_url}`,controls:!0,preload:"metadata",className:"w-full max-w-xs rounded-lg aspect-video sm:max-w-md"}):(J=a.media_type)!=null&&J.startsWith("image")?e.jsx("img",{src:`/storage/${a.media_url}`,alt:"Media untuk pesan",className:"object-cover w-auto transition-opacity rounded-lg shadow-sm cursor-pointer max-h-48 hover:opacity-95 sm:max-h-64",onClick:()=>window.open(`/storage/${a.media_url}`,"_blank"),loading:"lazy"}):e.jsxs("a",{href:`/storage/${a.media_url}`,target:"_blank",rel:"noopener noreferrer",className:`inline-flex items-center space-x-2 rounded border p-2 hover:underline ${r?"border-primary-foreground/30 text-primary-foreground":"border-border text-primary"}`,children:[e.jsx(Q,{className:"w-3 h-3 sm:h-4 sm:w-4"}),e.jsx("span",{className:"text-xs sm:text-sm",children:"File Attachment"})]})})]}),v&&N&&e.jsxs("div",{className:`mt-1 flex items-center justify-between ${r?"flex-row-reverse":"flex-row"}`,children:[e.jsx("div",{className:`text-xs text-muted-foreground opacity-0 transition-opacity hover:opacity-100 ${r?"text-right":"text-left"}`,children:_(a.created_at)}),e.jsx(c,{variant:"ghost",size:"sm",className:"w-5 h-5 p-0 transition-opacity opacity-0 group-hover:opacity-100 sm:h-6 sm:w-6",onClick:()=>H(a),children:e.jsx(G,{className:"w-2 h-2 sm:h-3 sm:w-3"})})]})]})]})},a.id)})]},s)),d.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full py-8 text-center sm:py-12",children:[e.jsx(F,{className:"w-10 h-10 mb-3 text-muted-foreground sm:mb-4 sm:h-12 sm:w-12"}),e.jsx("h3",{className:"mb-2 text-base font-medium text-foreground sm:text-lg",children:"Belum ada pesan"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Mulai percakapan dengan mengirim pesan pertama"})]}),e.jsx("div",{ref:ee})]}),e.jsxs("div",{className:"p-3 border-t bg-card sm:p-4",children:[x&&e.jsx("div",{className:"p-2 mb-2 border-l-4 rounded-lg border-primary bg-muted sm:mb-3 sm:p-3",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center mb-1 space-x-2",children:[e.jsx(G,{className:"w-3 h-3 text-primary sm:h-4 sm:w-4"}),e.jsxs("span",{className:"text-xs font-medium text-foreground sm:text-sm",children:["Membalas"," ",x.user.id===u?"Anda":x.user.name]})]}),e.jsx("p",{className:"text-xs truncate text-muted-foreground sm:text-sm",children:x.content||(x.media_url?"Media":"Pesan")})]}),e.jsx(c,{variant:"ghost",size:"sm",onClick:O,className:"w-5 h-5 p-0 ml-2 sm:h-6 sm:w-6",children:e.jsx(D,{className:"w-3 h-3 sm:h-4 sm:w-4"})})]})}),m&&w&&e.jsxs("div",{className:"p-2 mb-2 rounded-lg bg-muted sm:mb-3 sm:p-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center flex-1 min-w-0 space-x-2 sm:space-x-3",children:[ce(m.type),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-xs font-medium truncate sm:text-sm",children:m.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[(m.size/1024/1024).toFixed(2)," ","MB"]})]})]}),e.jsx(c,{variant:"ghost",size:"sm",onClick:W,className:"w-5 h-5 p-0 ml-2 sm:h-6 sm:w-6",children:e.jsx(D,{className:"w-3 h-3 sm:h-4 sm:w-4"})})]}),m.type.startsWith("image/")&&e.jsx("div",{className:"mt-2 sm:mt-3",children:e.jsx("img",{src:w,alt:"Preview",className:"object-cover w-auto border border-gray-200 rounded-lg shadow-sm max-h-24 sm:max-h-32"})}),m.type.startsWith("video/")&&e.jsx("div",{className:"mt-2 sm:mt-3",children:e.jsx("video",{src:w,className:"w-full max-w-xs border border-gray-200 rounded-lg shadow-sm aspect-video",controls:!0})})]}),e.jsxs("form",{onSubmit:V,className:"flex items-end space-x-1 sm:space-x-2",children:[e.jsx(c,{type:"button",variant:"ghost",size:"sm",onClick:()=>{var s;return(s=M.current)==null?void 0:s.click()},className:"h-8 px-2 sm:h-10 sm:px-3",children:e.jsx(Q,{className:"w-4 h-4"})}),e.jsx("div",{className:"flex-1",children:e.jsx(pe,{value:g,onChange:s=>R(s.target.value),placeholder:"Tulis pesan...",className:"max-h-20 min-h-[32px] resize-none text-sm sm:max-h-32 sm:min-h-[40px]",onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),V(s))}})}),e.jsx(c,{type:"submit",disabled:!g.trim()&&!m||I,size:"sm",className:"h-8 px-2 sm:h-10 sm:px-3",children:e.jsx(oe,{className:"w-4 h-4"})})]}),e.jsx("p",{className:"hidden mt-2 text-xs text-muted-foreground sm:block",children:"Tekan Enter untuk mengirim, Shift + Enter untuk baris baru"})]})]}):e.jsx("div",{className:"flex items-center justify-center flex-1 p-4",children:e.jsxs("div",{className:"max-w-md text-center",children:[e.jsx(F,{className:"w-10 h-10 mx-auto mb-3 text-muted-foreground sm:mb-4 sm:h-12 sm:w-12"}),e.jsx("h3",{className:"mb-2 text-base font-medium text-foreground sm:text-lg",children:"Pilih Grup Chat"}),e.jsx("p",{className:"mb-4 text-sm text-muted-foreground",children:p?e.jsx(e.Fragment,{children:"Tap tombol menu untuk melihat daftar grup chat dan mulai percakapan."}):e.jsx(e.Fragment,{children:"Pilih grup chat dari sidebar untuk mulai percakapan dengan sesama peserta misi."})}),p&&e.jsxs(c,{onClick:K,className:"w-full sm:w-auto",children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"Lihat Grup Chat"]})]})})})]})},Le=()=>{var h,k;const{props:d}=de(),{messages:o,allGroups:l}=d,u=d.activeGroupId;return console.log("messages",o),console.log("allGroups",l),console.log("activeGroupId",u),e.jsx(xe,{currentPage:"chat",children:e.jsx(ve,{messages:o,allGroups:l,activeGroupId:u,currentUserId:((k=(h=d.auth)==null?void 0:h.user)==null?void 0:k.id)??0})})};export{Le as default};
